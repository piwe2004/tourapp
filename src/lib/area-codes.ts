/**
 * @file src/lib/area-codes.ts
 * @description 지역명/시군구명을 DB 조회용 코드로 변환하기 위한 매핑 데이터와 헬퍼 함수
 */

// 지역 코드 -> 시군구 코드 -> 시군구명 매핑
export const SIGUNGU_MAP: Record<string, Record<string, string>> = {
  // 서울(1)
  "1": {
    "1": "강남구", "2": "강동구", "3": "강북구", "4": "강서구", "5": "관악구",
    "6": "광진구", "7": "구로구", "8": "금천구", "9": "노원구", "10": "도봉구",
    "11": "동대문구", "12": "동작구", "13": "마포구", "14": "서대문구", "15": "서초구",
    "16": "성동구", "17": "성북구", "18": "송파구", "19": "양천구", "20": "영등포구",
    "21": "용산구", "22": "은평구", "23": "종로구", "24": "중구", "25": "중랑구",
    "99": "기타지역"
  },
  
  // 대전(3)
  "3": {
    "1": "대덕구", "2": "동구", "3": "서구", "4": "유성구", "5": "중구",
    "99": "기타지역"
  },

  // 대구(4)
  "4": {
    "1": "남구", "2": "달서구", "3": "달성군", "4": "동구", "5": "북구",
    "6": "서구", "7": "수성구", "8": "중구", "9": "군위군",
    "99": "기타지역"
  },

  // 광주(5)
  "5": {
    "1": "광산구", "2": "남구", "3": "동구", "4": "북구", "5": "서구",
    "99": "기타지역"
  },

  // 부산(6)
  "6": {
    "1": "강서구", "2": "금정구", "3": "기장군", "4": "남구", "5": "동구",
    "6": "동래구", "7": "부산진구", "8": "북구", "9": "사상구", "10": "사하구",
    "11": "서구", "12": "수영구", "13": "연제구", "14": "영도구", "15": "중구",
    "16": "해운대구",
    "99": "기타지역"
  },
  // 울산(7)
  "7": {
    "1": "중구", "2": "남구", "3": "동구", "4": "북구", "5": "울주군",
    "99": "기타지역"
  },

  // 세종(8)
  "8": {
    "1": "세종특별자치시"
  },

  // 경기(31)
  "31": {
    "1": "가평군", "2": "고양시", "3": "과천시", "4": "광명시", "5": "광주시",
    "6": "구리시", "7": "군포시", "8": "김포시", "9": "남양주시", "10": "동두천시",
    "11": "부천시", "12": "성남시", "13": "수원시", "14": "시흥시", "15": "안산시",
    "16": "안성시", "17": "안양시", "18": "양주시", "19": "양평군", "20": "여주시",
    "21": "연천군", "22": "오산시", "23": "용인시", "24": "의왕시", "25": "의정부시",
    "26": "이천시", "27": "파주시", "28": "평택시", "29": "포천시", "30": "하남시",
    "31": "화성시",
    "99": "기타지역"
  },

  // 강원(32)
  "32": {
    "1": "강릉시", "2": "고성군", "3": "동해시", "4": "삼척시", "5": "속초시",
    "6": "양구군", "7": "양양군", "8": "영월군", "9": "원주시", "10": "인제군",
    "11": "정선군", "12": "철원군", "13": "춘천시", "14": "태백시", "15": "평창군",
    "16": "홍천군", "17": "화천군", "18": "횡성군",
    "99": "기타지역"
  },

  // 충북(33)
  "33": {
    "1": "괴산군", "2": "단양군", "3": "보은군", "4": "영동군", "5": "옥천군",
    "6": "음성군", "7": "제천시", "8": "진천군", "9": "청원군", "10": "청주시",
    "11": "충주시", "12": "증평군",
    "99": "기타지역"
  },
  // 충남(34)
  "34": {
    "1": "공주시", "2": "금산군", "3": "논산시", "4": "당진시", "5": "보령시",
    "6": "부여군", "7": "서산시", "8": "서천군", "9": "아산시", "11": "예산군",
    "12": "천안시", "13": "청양군", "14": "태안군", "15": "홍성군", "16": "계룡시",
    "99": "기타지역"
  },

  // 경북(35)
  "35": {
    "1": "경산시", "2": "경주시", "3": "고령군", "4": "구미시", "6": "김천시",
    "7": "문경시", "8": "봉화군", "9": "상주시", "10": "성주군", "11": "안동시",
    "12": "영덕군", "13": "영양군", "14": "영주시", "15": "영천시", "16": "예천군",
    "17": "울릉군", "18": "울진군", "19": "의성군", "20": "청도군", "21": "청송군",
    "22": "칠곡군", "23": "포항시",
    "99": "기타지역"
  },

  // 경남(36)
  "36": {
    "1": "거제시", "2": "거창군", "3": "고성군", "4": "김해시", "5": "남해군",
    "6": "마산시", "7": "밀양시", "8": "사천시", "9": "산청군", "10": "양산시",
    "12": "의령군", "13": "진주시", "14": "진해시", "15": "창녕군", "16": "창원시",
    "17": "통영시", "18": "하동군", "19": "함안군", "20": "함양군", "21": "합천군",
    "99": "기타지역"
  },

  // 전북(37)
  "37": {
    "1": "고창군", "2": "군산시", "3": "김제시", "4": "남원시", "5": "무주군",
    "6": "부안군", "7": "순창군", "8": "완주군", "9": "익산시", "10": "임실군",
    "11": "장수군", "12": "전주시", "13": "정읍시", "14": "진안군",
    "99": "기타지역"
  },

  // 전남(38)
  "38": {
    "1": "강진군", "2": "고흥군", "3": "곡성군", "4": "광양시", "5": "구례군",
    "6": "나주시", "7": "담양군", "8": "목포시", "9": "무안군", "10": "보성군",
    "11": "순천시", "12": "신안군", "13": "여수시", "16": "영광군", "17": "영암군",
    "18": "완도군", "19": "장성군", "20": "장흥군", "21": "진도군", "22": "함평군",
    "23": "해남군", "24": "화순군",
    "99": "기타지역"
  },

  // 제주(39)
  "39": {
    "1": "남제주군", "2": "북제주군", "3": "서귀포시", "4": "제주시",
    "99": "기타지역"
  }
};

// 지역명 -> 지역코드 역매핑 테이블
const AREA_NAME_TO_CODE: Record<string, string> = {
  "서울": "1",
  "대전": "3",
  "대구": "4",
  "광주": "5",
  "부산": "6",
  "울산": "7",
  "세종": "8",
  "경기": "31",
  "강원": "32",
  "충북": "33", // 오타 수정
  "충남": "34",
  "경북": "35",
  "경남": "36",
  "전북": "37",
  "전남": "38",
  "제주": "39"
  // 사용자 제공 데이터 기준. 추후 경기, 강원, 제주 등 추가 필요
};

/**
 * @desc 지역명을 지역코드(areaCd)로 변환합니다.
 * @param regionName 지역명 (예: "서울", "부산")
 * @returns 지역코드 (없으면 null)
 */
export function getAreaCodeFromName(regionName: string): string | null {
  if (!regionName) return null;
  // 간단한 정규화 (공백 제거 등)
  const normalized = regionName.trim();
  
  // 정확히 매칭되거나 포함되는 경우 찾기
  for (const [name, code] of Object.entries(AREA_NAME_TO_CODE)) {
    if (normalized.includes(name) || name.includes(normalized)) {
      return code;
    }
  }
  return null;
}

/**
 * @desc 시군구명을 시군구코드(sigeCd)로 변환합니다.
 * @param areaCd 지역코드 (예: "1" - 서울)
 * @param districtName 시군구명 (예: "강남구")
 * @returns 시군구코드 (없으면 null)
 */
export function getSigunguCodeFromName(areaCd: string, districtName: string): string | null {
  if (!areaCd || !districtName || !SIGUNGU_MAP[areaCd]) return null;
  
  const districtMap = SIGUNGU_MAP[areaCd];
  const normalized = districtName.trim();

  for (const [code, name] of Object.entries(districtMap)) {
    if (name === normalized || normalized.includes(name) || name.includes(normalized)) {
      return code;
    }
  }
  return null;
}

/**
 * @desc 지역명(도/광역시) 또는 시군구명을 입력받아 AreaCode와 SigunguCode를 찾습니다.
 * "전주" -> 전북(37), 전주시(12) -> { areaCd: "37", sigeCd: "12" }
 * "부산" -> 부산(6) -> { areaCd: "6" }
 * "해운대" -> 부산(6), 해운대구(16) -> { areaCd: "6", sigeCd: "16" }
 * @param query 사용자가 입력한 지역 검색어
 */
export function findRegionCodes(query: string): { areaCd: string; sigeCd?: string } | null {
  if (!query) return null;
  const normalized = query.trim();

  // 1. 도/광역시 레벨 검색
  // "전북", "충남" 등
  const directAreaCode = getAreaCodeFromName(normalized);
  if (directAreaCode) {
      return { areaCd: directAreaCode };
  }

  // 2. 시군구 레벨 전체 검색 (Recursive Search)
  // 입력: "전주", "해운대", "가평" 등
  for (const [aCode, districts] of Object.entries(SIGUNGU_MAP)) {
      for (const [sCode, name] of Object.entries(districts)) {
          // 정확히 일치하거나, "전주시" vs "전주" 처럼 포함 관계일 때
          if (normalized === name || (name.length > 2 && normalized.includes(name.replace("시", "").replace("군", "").replace("구", ""))) || name.includes(normalized)) {
              return { areaCd: aCode, sigeCd: sCode };
          }
      }
  }

  return null;
}
